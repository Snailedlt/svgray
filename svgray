quiet=0
output_file=""

while getopts ":hqo:" opt; do
  case ${opt} in
  q)
    quiet=1
    ;;
  h)
    echo "Usage: svgray [-q] [-o output_file] FILE"
    exit 0
    ;;
  o)
    output_file="$OPTARG"
    ;;
  \?)
    echo "Invalid option: -$OPTARG" >&2
    exit 1
    ;;
  :)
    echo "Option -$OPTARG requires an argument." >&2
    exit 1
    ;;
  esac
done
shift $((OPTIND - 1))

# Check if at least one argument is provided (input file)
if [ $# -eq 0 ]; then
  echo "Usage: svgray [-q] [-o output_file] FILE"
  exit 1
fi

input_file="$1"

# Use the input file name as the output file if not specified
if [ -z "$output_file" ]; then
  output_file="$input_file"
fi

tempfile=$(mktemp)
python3 $(dirname $0)/.svgray.py "$input_file" >"$tempfile" || {
  echo "Failed to convert to grayscale"
  exit 1
}
svgo --quiet --pretty "$tempfile" -o "$tempfile" || {
  echo "Failed to optimize"
  exit 1
}

# Ensure the output directory exists
mkdir -p "$(dirname "$output_file")"

mv "$tempfile" "$output_file" || {
  echo "Failed to write to $output_file"
  exit 1
}

if [ $quiet -eq 0 ]; then
  echo "Wrote to $output_file."
fi

exit 0
